{% extends 'base.html' %}

{% block title %}Andrew's Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
    }
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .dashboard-title {
        font-size: 28px;
        color: #333;
    }
    .dashboard-actions button {
        margin-left: 10px;
    }
    .dashboard-content {
        display: flex;
        gap: 20px;
    }
    .todo-list, .schedule {
        flex: 1;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
        color: #007bff;
        margin-bottom: 15px;
    }
    ul {
        list-style-type: none;
        padding: 0;
    }
    .todo-item, .schedule-item {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .todo-title, .schedule-title {
        font-weight: bold;
    }
    .todo-due, .schedule-time {
        font-size: 0.9em;
        color: #6c757d;
    }
    .todo-item.submitted {
        background-color: #d4edda; 
    }
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    .btn:hover {
        opacity: 0.9;
    }
    .schedule-grid {
        position: relative;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(12, 60px);
        gap: 5px;
        border: 1px solid #ccc;
    }
    .schedule-item {
        position: absolute;
        background-color: #e0f7fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 5px;
        text-align: center;
        left: 0;
        right: 0;
        overflow: hidden; /* Ensures content does not overflow the box */
        white-space: nowrap; /* Prevents text from wrapping to the next line */
        text-overflow: ellipsis; /* Adds ellipsis (...) for overflowing text */
    }
    .day-separator {
        border-bottom: 1px solid lightblue; /* Thin line for days */
        margin: 10px 0;
        padding: 5px 0;
        font-weight: normal; /* Keep text weight normal */
    }
    .week-separator {
        border-bottom: 2px solid blue; /* Bold line for weeks */
        margin: 15px 0;
        padding: 10px 0;
        font-weight: bold; /* Make week text bold */
        font-size: 1.2em;
    }
    .current-time-line {
        position: absolute;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: #007bff;
        z-index: 1;
    }
    .schedule-container {
    display: flex;
}

.time-scale {
    width: 60px; /* Adjusted width for time labels */
    display: flex;
    flex-direction: column;
}

.time-slot {
    height: 30px; /* 30 minutes height for each slot */
    border-bottom: 1px solid #ccc;
    text-align: right;
    padding-right: 5px;
    font-size: 0.8em;
}

.schedule-grid {
    flex: 1;
    position: relative;
    display: grid;
    grid-template-rows: repeat(48, 30px); /* 48 half-hour slots */
    border-left: 1px solid #ccc;
}

.schedule-item {
    position: absolute;
    background-color: #e0f7fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 5px;
    text-align: center;
    left: 0;
    right: 0;
}

.current-time-line {
    position: absolute;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #007bff;
    z-index: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Andrew's Dashboard</h1>
        <div class="dashboard-actions">
            <button id="pull-canvas" class="btn btn-primary">Pull Canvas Data</button>
            <button id="sort-todos" class="btn btn-secondary">Sort by Date</button>
            <button id="refresh-button" class="btn btn-secondary" onclick="refreshData()">Refresh Data</button>
        </div>
    </div>
    <div class="dashboard-content">
        <div class="todo-list">
            <h2>Todo List</h2>
            <ul id="todo-list">
                {% for todo in todos %}
                <li class="todo-item {% if todo.submitted %}submitted{% endif %}" data-date="{{ todo.due_date|date:'Y-m-d' }}">
                    <span class="todo-title">{{ todo.course }}</span>
                    <span class="todo-title">{{ todo.title }}</span>
                    <span class="todo-due">Due: {{ todo.due_date|default:"No due date"|date:"M d, Y" }}</span>
                </li>
                {% empty %}
                <li>No todos available</li>
                {% endfor %}
            </ul>
        </div>
        <div class="schedule">
            <h2>Daily Schedule</h2>
            <div class="schedule-container">
                <div class="time-scale">
                    {% for time in time_slots %}
                        <div class="time-slot">{{ time }}</div>
                    {% endfor %}
                </div>
                <div class="schedule-grid" id="schedule">
                    {% for cls in daily_schedule %}
                    <div class="schedule-item" style="top: calc({{ cls.start_position }} * 30px); height: calc({{ cls.duration }} * 30px);">
                        <strong>{{ cls.course }}</strong><br>
                        {{ cls.time }}<br>
                        {{ cls.location }}
                    </div>
                    {% endfor %}
                    <div class="current-time-line" id="current-time-line"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const scheduleItems = document.querySelectorAll('.schedule-item');
    scheduleItems.forEach(item => {
        const time = item.querySelector('strong + br').nextSibling.textContent.trim(); // Get course time
        const [start, end] = time.split(' - ');
        const [startHour, startMinute] = parseTime(start);
        const [endHour, endMinute] = parseTime(end);
        const startPosition = (startHour * 2) + (startMinute / 30); // Calculate grid position
        const height = ((endHour * 60 + endMinute) - (startHour * 60 + startMinute)) / 30; // Duration in 30 min slots

        item.style.top = `${startPosition * 30}px`; // Set top position based on start
        item.style.height = `${height * 30}px`; // Set height based on duration
    });

    updateCurrentTimeLine();
    setInterval(updateCurrentTimeLine, 60000); // Update every minute
});

function parseTime(time) {
    const [hourMinute, modifier] = time.split(' ');
    let [hour, minute] = hourMinute.split(':').map(Number);
    if (modifier === 'PM' && hour !== 12) hour += 12;
    if (modifier === 'AM' && hour === 12) hour = 0;
    return [hour, minute];
}

function updateCurrentTimeLine() {
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    const linePosition = currentTime / 30; // Calculate position based on 30-minute slots
    const currentTimeLine = document.getElementById('current-time-line');
    currentTimeLine.style.top = `${linePosition * 30}px`;
}

document.getElementById('pull-canvas').addEventListener('click', function() {
    this.disabled = true;
    this.textContent = 'Pulling data...';
    fetch('/personalwork/pull_canvas/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Canvas data pulled successfully!');
                location.reload();
            } else {
                alert('Failed to pull Canvas data: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while pulling Canvas data.');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'Pull Canvas Data';
        });
});

function refreshData() {
    location.reload();
}
document.getElementById('sort-todos').addEventListener('click', function() {
    const todoList = document.getElementById('todo-list');
    const todos = Array.from(todoList.children);

    todos.sort((a, b) => {
        const dateA = new Date(a.dataset.date);
        const dateB = new Date(b.dataset.date);
        return dateA - dateB;
    });

    todoList.innerHTML = '';
    let currentDate = null;
    let currentWeek = null;

    todos.forEach(todo => {
        const todoDate = new Date(todo.dataset.date);
        if (!isNaN(todoDate.getTime())) {
            const formattedDate = todoDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const weekNumber = getWeekNumber(todoDate);

            if (currentWeek !== weekNumber) {
                const weekSeparator = document.createElement('li');
                weekSeparator.className = 'week-separator';
                weekSeparator.textContent = `Week of ${todoDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
                todoList.appendChild(weekSeparator);
                currentWeek = weekNumber;
            }

            if (currentDate !== formattedDate) {
                const daySeparator = document.createElement('li');
                daySeparator.className = 'day-separator';
                daySeparator.textContent = formattedDate;
                todoList.appendChild(daySeparator);
                currentDate = formattedDate;
            }
        }
        todoList.appendChild(todo);
    });
});

function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}
</script>
{% endblock %}