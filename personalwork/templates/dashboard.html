{% extends 'base.html' %}

{% block title %}Andrew's Dashboard{% endblock %}

{% block extra_css %}
<style>

    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
    }
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .dashboard-title {
        font-size: 28px;
        color: #333;
    }
    .dashboard-actions button {
        margin-left: 10px;
    }
    .dashboard-content {
        display: flex;
        gap: 20px;
    }
    .todo-list {
        flex: 2;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        padding-right:10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .schedule {
        flex: 1;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        padding-left:10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
        color: #011425;
        margin-bottom: 15px;
    }
    ul {
        list-style-type: none;
        padding: 0;
    }
    .todo-item, .schedule-item {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .todo-title, .schedule-title {
        font-weight: bold;
    }
    .todo-due, .schedule-time {
        font-size: 0.9em;
        color: #6c757d;
    }
    .todo-list a {
    text-decoration: underline;
    color: inherit; /* Keeps the text color the same as the surrounding text */
  }
    .todo-item.submitted {
        background-color: #d4edda; 
    }
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    .btn:hover {
        opacity: 0.9;
    }
    .dropdown-menu {
        display: none;
        position: absolute;
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 10px;
        border-radius: 4px;
        z-index: 1000;
    }
    .dropdown-menu.active {
        display: block;
    }
    .dropdown-menu input,
    .dropdown-menu select {
        margin-bottom: 10px;
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .schedule-grid {
        position: relative;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(12, 60px);
        gap: 5px;
        border: 1px solid #ccc;
    }
    .schedule-item {
        position: absolute;
        flex: 2;
        background-color: #e0f7fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 5px;
        text-align: center;
        left: 0;
        right: 0;
        overflow: hidden; /* Ensures content does not overflow the box */
        white-space: nowrap; /* Prevents text from wrapping to the next line */
        text-overflow: ellipsis; /* Adds ellipsis (...) for overflowing text */
    }
    .day-separator {
        border-bottom: 1px solid lightblue; /* Thin line for days */
        margin: 10px 0;
        padding: 5px 0;
        font-weight: normal; /* Keep text weight normal */
    }
    .week-separator {
        border-bottom: 2px solid blue; /* Bold line for weeks */
        margin: 15px 0;
        padding: 10px 0;
        font-weight: bold; /* Make week text bold */
        font-size: 1.2em;
    }
    .current-time-line {
        position: absolute;
        flex:1;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: #007bff;
        z-index: 1;
    }
    .schedule-container {
    display: flex;
}

.time-scale {
    width: 60px; 
    display: flex;
    flex-direction: column;
}

.time-slot {
    height: 29.2px; /* 30 minutes height for each slot */
    border-bottom: 1px solid #ccc;
    text-align: right;
    padding-right: 5px;
    font-size: 0.8em;
}

.schedule-grid {
    flex: 1;
    position: relative;
    display: grid;
    grid-template-rows: repeat(48, 30px); /* 48 half-hour slots */
    border-left: 1px solid #ccc;
}

.schedule-item {
    position: absolute;
    background-color: #e0f7fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 5px;
    text-align: center;
    left: 0;
    right: 0;
}

.schedule-item.recurring {
    background-color: #9fd5dc;
}

.schedule-item::before {
  content: none; /* This removes the dot */
}
   
.schedule-event {
    position: relative;
    z-index: 1;
    transition: z-index 0.3s;
}

.schedule-event:hover {
    z-index: 2;
}
.delete-icon {
        cursor: pointer;
        position: absolute;
        right: 5px;
        top: 5px;
        display: none;
    }
/* Increase the width of the dropdown container */
.dropdown-menu {
  width: auto;
  min-width: 300px;
  padding: 15px;
}

/* Ensure form inputs fit within the container */
.dropdown-menu .form-control {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

/* Adjust padding and margins of form elements */
.dropdown-menu .form-group {
  margin-bottom: 10px;
}

.dropdown-menu label {
  display: block;
  margin-bottom: 5px;
}

/* Make the dropdown responsive */
@media (max-width: 768px) {
  .dropdown-menu {
    width: 100%;
  }
}

/* Adjust specific inputs if needed */
.dropdown-menu .time-picker,
.dropdown-menu .date-picker {
  width: 100%;
}

.time-input {
    width: 100%;
    padding: 5px;
    margin-bottom: 10px;
}

.current-time-line {
    position: absolute;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #007bff;
    z-index: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Andrew's Dashboard</h1>
        <div class="dashboard-actions">
            <button id="pull-canvas" class="btn btn-primary">Pull Canvas Data</button>
            <button id="pull-gradescope" class="btn btn-primary">Pull Gradescope Data</button>
            <button id="sort-todos" class="btn btn-secondary">Sort by Date</button>
            <button id="refresh-button" class="btn btn-secondary" onclick="refreshData()">Refresh Data</button>
            <button id="add-schedule-button" class="btn btn-secondary">Add Schedule</button>
                <div id="schedule-dropdown" class="dropdown-menu p-3" style="width: 300px;">
                    <form id="schedule-form">
                        <div class="mb-3">
                            <label for="day" class="form-label">Day</label>
                            <select id="day" name="day" class="form-select" required>
                                <option value="" disabled selected>Select a day</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="start_time" class="form-label">Start Time</label>
                            <input type="text" id="start_time" name="start_time" class="form-control time-input" placeholder="00:00 AM" required>
                        </div>
                        <div class="mb-3">
                            <label for="end_time" class="form-label">End Time</label>
                            <input type="text" id="end_time" name="end_time" class="form-control time-input" placeholder="00:00 PM" required>
                        </div>
                        <div class="mb-3">
                            <label for="event" class="form-label">Event</label>
                            <input type="text" id="event" name="event" class="form-control" placeholder="Enter event name" required>
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" id="location" name="location" class="form-control" placeholder="Enter location">
                        </div>
                        <div class="mb-3 form-check" style="display: flex; align-items: center;">
                            <label for="recurring" class="form-check-label">Recurring</label>
                            <input type="checkbox" id="recurring" name="recurring" class="form-check-input" style="margin-right: 0.5rem;">
                            
                        </div>
                        <button id="submit-schedule" type="submit" class="btn btn-primary w-100">Save</button>
                    </form>
                </div>
        </div>
    </div>
    <div class="dashboard-content">
        <div class="todo-list">
           
            <h2>Assignments</h2>
            <ul id="todo-list">
                {% for todo in todos %}
                <li class="todo-item {% if todo.submitted %}submitted{% endif %}" data-date="{{ todo.due_date|date:'Y-m-d' }}">
                    <span class="todo-title">{{ todo.course }}</span>
                    <a href="{{ todo.html_link }}" target="_blank">
                    <span class="todo-title">{{ todo.title }}</span>
                    </a>
                    <span class="todo-due">Due: {{ todo.due_date|default:"No due date"|date:"M d, Y" }}</span>
                </li>
                {% empty %}
                <li>No todos available</li>
                {% endfor %}
            </ul>
        </div>
        <div class="schedule">
            <h2>Daily Schedule</h2>
            <div class="schedule-container">
                <div class="time-scale">
                    {% for time in time_slots %}
                        <div class="time-slot">{{ time }}</div>
                    {% endfor %}
                </div>
                <div class="schedule-grid" id="schedule">
                    {% for cls in daily_schedule %}
                    <div class="schedule-item" 
                        style="top: calc({{ cls.start_position }} * 30px); height: calc({{ cls.duration }} * 30px);" 
                        data-id="{{ cls.id }}" 
                        onclick="handleEventClick(this)">
                        <strong>{{ cls.course }}</strong><br>
                        {{ cls.time }}<br>
                        {{ cls.location }}
                        <span class="delete-icon" style="display:none;" onclick="deleteEvent(event, '{{ cls.id }}')">🗑️</span>
                    </div>
                    {% endfor %}

                    {% for cls in schedules %}
                        {% if cls.recurring or cls.dateSet >= current_date %}
                            <div class="schedule-item {% if cls.recurring == 'True' or cls.recurring %}recurring{% endif %}" 
                                style="top: calc({{ cls.start_position }} * 30px); height: calc({{ cls.duration }} * 30px);"
                                data-id="{{ cls.id }}" 
                                onclick="handleEventClick(this)">
                                <strong>{{ cls.course }}</strong><br>
                                {{ cls.time }}<br>
                                {{ cls.location }}
                                <span class="delete-icon" style="display:none;" onclick="deleteEvent(event, '{{ cls.id }}')">🗑️</span>
                            </div>
                        {% endif %}
                    {% endfor %}
                    <div class="current-time-line" id="current-time-line"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
function handleEventClick(element, event) {
    updateEventLayer(element);
    showDeleteIcon(element);
}

function showDeleteIcon(element) {
    const deleteIcon = element.querySelector('.delete-icon');
    if (deleteIcon) {
        deleteIcon.style.display = 'inline';
        setTimeout(() => {
            deleteIcon.style.display = 'none';
        }, 3000); // Hide after 3 seconds
    } else {
        console.error('Delete icon not found in the element');
    }
}


function deleteEvent(event, eventId) {
    event.stopPropagation(); // Prevent triggering the onclick of the parent div
    console.log("Attempting to delete event with ID:", eventId);
    
    if (!eventId) {
        console.error("Event ID is undefined or empty");
        alert("Cannot delete event: ID is missing");
        return;
    }

    if (confirm('Are you sure you want to delete this event?')) {
        fetch('personalwork/delete_event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `id=${eventId}`
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                console.log("Event deleted successfully on server");
                const eventElement = document.querySelector(`.schedule-event[data-id="${eventId}"]`);
                if (eventElement) {
                    eventElement.remove();
                    console.log("Event element removed from DOM");
                } else {
                    console.error(`Could not find the event element to remove. ID: ${eventId}`);
                }
            } else {
                console.error("Failed to delete event:", data.message);
                alert(`Failed to delete event: ${data.message}`);
            }
        })
        .catch(error => {
            console.error("Error deleting event:", error);
            alert(`An error occurred while deleting the event: ${error.message}`);
        });
    }
}


function updateEventLayer(element) {
    const eventId = element.dataset.id;
    console.log("Updating event layer for ID:", eventId);
    fetch('update_event_layer/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `id=${eventId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log("Event layer updated successfully");
            element.parentNode.appendChild(element);
        } else {
            console.error("Failed to update event layer:", data);
        }
    })
    .catch(error => console.error("Error updating event layer:", error));
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


document.addEventListener('DOMContentLoaded', function() {
    const scheduleItems = document.querySelectorAll('.schedule-item');
    scheduleItems.forEach(item => {
        const time = item.querySelector('strong + br').nextSibling.textContent.trim(); // Get course time
        const [start, end] = time.split(' - ');
        const [startHour, startMinute] = parseTime(start);
        const [endHour, endMinute] = parseTime(end);
        const startPosition = (startHour * 2) + (startMinute / 30); // Calculate grid position
        const height = ((endHour * 60 + endMinute) - (startHour * 60 + startMinute)) / 30; // Duration in 30 min slots

        item.style.top = `${startPosition * 30}px`; // Set top position based on start
        item.style.height = `${height * 30}px`; // Set height based on duration
    });

    updateCurrentTimeLine();
    setInterval(updateCurrentTimeLine, 60000); // Update every minute
});

function parseTime(time) {
    const [hourMinute, modifier] = time.split(' ');
    let [hour, minute] = hourMinute.split(':').map(Number);
    if (modifier === 'PM' && hour !== 12) hour += 12;
    if (modifier === 'AM' && hour === 12) hour = 0;
    return [hour, minute];
}

function updateCurrentTimeLine() {
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    const linePosition = currentTime / 30; // Calculate position based on 30-minute slots
    const currentTimeLine = document.getElementById('current-time-line');
    currentTimeLine.style.top = `${linePosition * 30}px`;
}


document.addEventListener('DOMContentLoaded', function() {
    const addScheduleButton = document.getElementById('add-schedule-button');
    const scheduleDropdown = document.getElementById('schedule-dropdown');
    const scheduleForm = document.getElementById('schedule-form');

    addScheduleButton.addEventListener('click', function() {
        scheduleDropdown.classList.toggle('active');
    });

    scheduleForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(scheduleForm);
        fetch('/personalwork/add_schedule/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Schedule added successfully!');
                scheduleDropdown.classList.remove('active');
                scheduleForm.reset();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});


document.getElementById('pull-canvas').addEventListener('click', function() {
    this.disabled = true;
    this.textContent = 'Pulling data...';
    fetch('/personalwork/pull_canvas/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Canvas data pulled successfully!');
                location.reload();
            } else {
                alert('Failed to pull Canvas data: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while pulling Canvas data.');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'Pull Canvas Data';
        });
})


document.getElementById('pull-gradescope').addEventListener('click', function() {
    this.disabled = true;
    this.textContent = 'Pulling data...';
    fetch('/personalwork/pull_gradescope/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Gradescope data pulled successfully!');
                location.reload();
            } else {
                alert('Failed to pull Gradescope data: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while pulling Gradescope data.');
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'Pull Gradescope Data';
        });
})

function refreshData() {
    location.reload();
}
document.getElementById('sort-todos').addEventListener('click', function() {
    const todoList = document.getElementById('todo-list');
    const todos = Array.from(todoList.children);

    todos.sort((a, b) => {
        const dateA = new Date(a.dataset.date);
        const dateB = new Date(b.dataset.date);
        return dateA - dateB;
    });

    todoList.innerHTML = '';
    let currentDate = null;
    let currentWeek = null;

    todos.forEach(todo => {
        const todoDate = new Date(todo.dataset.date);
        if (!isNaN(todoDate.getTime())) {
            const formattedDate = todoDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const weekNumber = getWeekNumber(todoDate);

            if (currentWeek !== weekNumber) {
                const weekSeparator = document.createElement('li');
                weekSeparator.className = 'week-separator';
                weekSeparator.textContent = `Week of ${todoDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
                todoList.appendChild(weekSeparator);
                currentWeek = weekNumber;
            }

            if (currentDate !== formattedDate) {
                const daySeparator = document.createElement('li');
                daySeparator.className = 'day-separator';
                daySeparator.textContent = formattedDate;
                todoList.appendChild(daySeparator);
                currentDate = formattedDate;
            }
        }
        todoList.appendChild(todo);
    });
});

function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}
</script>
{% endblock %}